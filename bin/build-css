#!/usr/bin/env node

var fs = require('fs')
var postcss = require('postcss')
var syntax = require('postcss-scss')

var args = process.argv.slice(2)
var env = process.env.NODE_ENV || 'development'

if (args.length !== 2) {
	console.log('build-css requires input and output file paths')
	process.exit(1)
}

var input = args[0]
var output = args[1]

var plugins = [
	require('postcss-partial-import')({ extension: 'scss' }),
	require('postcss-extend')(),
	require('postcss-mixins')(),
	require('postcss-simple-vars')(),
	require('postcss-advanced-variables')(),
	require('postcss-nested')(),
	require('autoprefixer')({ browsers: 'last 2 versions' })
]

if (env === 'production') {
	plugins.push(require('cssnano'))
}

/**
 * Compile with PostCSS
 */
postcss(plugins)
	.process(fs.readFileSync(input, 'utf8'), {
		from: input,
		to: output,
		syntax,
		map: { inline: false }
	})
	.then(res => {
		fs.writeFileSync(`${output}`, res.css)
		fs.writeFileSync(`${output}.map`, res.map)
		process.exit(0)
	})
	.catch(err => {
		console.error(err.stack)
		process.exit(1)
	})
